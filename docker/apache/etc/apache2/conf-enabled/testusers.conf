<IfDefine TESTUSERS_LOGIN>
  # https://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypassmatch says:
  #   "When the URL parameter doesn't use any backreferences into the regular expression, the original URL will be appended to the URL parameter."
  # We don't want the original URL to be appended, so we add an empty backreference
  # () matches the empty string, and therefore $1 will be substituted with the empty string.
  <LocationMatch "^()/login/testusers/(?<primary_uid>.*)/(?<human_readable_uid>.*)/(?<alternative_uids>.*)$">
    ProxyPassMatch "http://${AUTHSERVER_LOCATION}/auth$1"
    RequestHeader set PEP-Spoof-Check "expr=%{file:/secrets_copy/spoofKey}"
    # To get a consistent set of headers, independent of the authentication mechanism, we copy the OIDC_CLAIM header to a PEP header
    RequestHeader set PEP-Primary-Uid "expr=%{env:MATCH_PRIMARY_UID}"
    RequestHeader set PEP-Human-Readable-Uid "expr=%{env:MATCH_HUMAN_READABLE_UID}"
    RequestHeader set PEP-Alternative-Uids "expr=%{env:MATCH_ALTERNATIVE_UIDS}"
  </LocationMatch>

  SetEnv TESTUSERS_LOGIN "true"
</IfDefine>
